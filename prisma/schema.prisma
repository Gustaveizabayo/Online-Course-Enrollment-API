generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(STUDENT)
  status    UserStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  otp        OTP?
  courses    Course[]    @relation("CourseInstructor")
  enrollments Enrollment[]
  payments   Payment[]
  applications InstructorApplication[]
  activityLogs ActivityLog[]
  reviews    Review[]
  progress   LessonProgress[]
  
  @@map("users")
}

model OTP {
  id        String   @id @default(cuid())
  userId    String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("otps")
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String
  price       Float
  duration    Int      // in hours
  category    String
  instructorId String
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  instructor User        @relation("CourseInstructor", fields: [instructorId], references: [id])
  enrollments Enrollment[]
  modules     Module[]
  reviews     Review[]
  
  @@map("courses")
}

model Enrollment {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  status    EnrollmentStatus @default(ACTIVE)
  enrolledAt DateTime @default(now())
  completedAt DateTime?
  
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment  Payment?
  
  @@unique([courseId, userId])
  @@map("enrollments")
}

model Payment {
  id           String   @id @default(cuid())
  enrollmentId String   @unique
  amount       Float
  currency     String   @default("USD")
  status       PaymentStatus @default(PENDING)
  paymentMethod String
  transactionId String?
  paidAt       DateTime?
  createdAt    DateTime @default(now())
  
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

model InstructorApplication {
  id            String   @id @default(cuid())
  userId        String
  bio           String
  qualifications String
  experience    String
  status        ApplicationStatus @default(PENDING)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("instructor_applications")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Module {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
  
  @@map("modules")
}

model Lesson {
  id        String     @id @default(cuid())
  moduleId  String
  title     String
  content   String?    // For article lessons
  videoUrl  String?    // For video lessons
  type      LessonType
  order     Int
  duration  Int        // in minutes
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  module   Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress LessonProgress[]
  
  @@map("lessons")
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
  RESOURCE
}

model LessonProgress {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  completed Boolean  @default(false)
  updatedAt DateTime @updatedAt
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model Review {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, userId])
  @@map("reviews")
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String
  details   Json?
  createdAt DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("activity_logs")
}
